<% layout('layout') %>

<h1 class="page-title"><i class="fa-solid fa-chart-pie"></i> Dashboard</h1>

<!-- MÉTRICAS SUPERIORES -->
<div class="grid-cards">
    <div class="metric-card card">
        <h3>Total de Equipamentos</h3>
        <p class="metric-value"><%= totais.equipamentos %></p>
    </div>

    <div class="metric-card card">
        <h3>Ordens Abertas</h3>
        <p class="metric-value"><%= totais.abertas %></p>
    </div>

    <div class="metric-card card">
        <h3>Ordens Fechadas</h3>
        <p class="metric-value"><%= totais.fechadas %></p>
    </div>

    <div class="metric-card card">
        <h3>Total de Correias em Estoque</h3>
        <p class="metric-value"><%= correiasCount || 0 %></p>
    </div>
</div>

<!-- GRÁFICOS LADO A LADO -->
<div class="chart-row">
    <!-- ORDENS POR TIPO -->
    <div class="chart-card card">
        <h2>Ordens por Tipo</h2>
        <canvas id="chartOrdensTipo"></canvas>
    </div>

    <!-- TOP 10 CORREIAS -->
    <div class="chart-card card">
        <h2>Top 10 Correias — Estoque</h2>
        <canvas id="chartCorreias"></canvas>
    </div>
</div>

<!-- BOTÕES -->
<div class="relatorio-actions">
    <a href="/relatorios/gerar-pdf-dashboard" class="btn btn-verde-escuro">
        <i class="fa-solid fa-file-pdf"></i> Exportar PDF do Dashboard
    </a>

    <a href="/relatorios" class="btn btn-cinza-escuro">Ver relatórios</a>
</div>

<!-- SCRIPTS -->
<script>
    const REL_ORDENS = <%- JSON.stringify(tipos || []) %>;
    const REL_CORREIAS = <%- JSON.stringify(correiasTop || []) %>;

    /* ---------------------
       GRÁFICO ORDENS POR TIPO
    ------------------------ */
    const ordensLabels = REL_ORDENS.map(x => x.tipo);
    const ordensValues = REL_ORDENS.map(x => x.total);

    new Chart(document.getElementById('chartOrdensTipo'), {
        type: 'pie',
        data: {
            labels: ordensLabels,
            datasets: [{
                data: ordensValues,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            devicePixelRatio: 2,
            plugins: { legend: { position: "bottom" } }
        }
    });

    /* ---------------------
       GRÁFICO TOP 10 CORREIAS
    ------------------------ */
    const corrLabels = REL_CORREIAS.map(x => x.nome);
    const corrValues = REL_CORREIAS.map(x => x.total);

    new Chart(document.getElementById('chartCorreias'), {
        type: 'bar',
        data: {
            labels: corrLabels,
            datasets: [{
                label: "Estoque",
                data: corrValues,
                borderWidth: 0
            }]
        },
        options: {
            responsive: true,
            maintainAspectRatio: true,
            devicePixelRatio: 2,
            indexAxis: 'y',
            plugins: { legend: { display: false } }
        }
    });
</script>
